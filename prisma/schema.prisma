generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              Int       @id @default(autoincrement())
  phone           String    @unique @db.VarChar(15)
  email           String?   @unique @db.VarChar(52)
  firstName       String?
  lastName        String?
  password        String
  role            Role      @default(USER)
  status          Status    @default(ACTIVE)
  lastLogin       DateTime?
  errorLoginCount Int       @default(0) @db.SmallInt
  randToken       String? // Made optional (usually nullable on create)
  image           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  accounts        Account[]

  @@index([phone])
}

model Account {
  id        Int           @id @default(autoincrement())
  userId    Int
  currency  Currency      @default(MMK)
  name      String?       @db.VarChar(50)
  balance   Decimal       @default(0) @db.Decimal(12, 2)
  status    AccountStatus @default(ACTIVE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id])

  outgoingTxns ExchangeTransaction[] @relation("FromAccount")
  incomingTxns ExchangeTransaction[] @relation("ToAccount")
  brokeredTxns BrokeredTransaction[]

  expenses Expense[]
  debts    Debt[]

  capitalEntries CapitalEntry[]
  dailyClosings  DailyClosing[]

  bridgeTxns CrossTransaction[] @relation("BridgeAccount")
  targetTxns CrossTransaction[] @relation("TargetAccount")

  @@unique([userId, name])
}

model Supplier {
  id      Int     @id @default(autoincrement())
  name    String  @unique
  phone   String?
  address String?

  transactions BrokeredTransaction[]
  crossTxns    CrossTransaction[]

  createdAt DateTime @default(now())
}

model BrokeredTransaction {
  id              Int      @id @default(autoincrement())
  profitAccountId Int
  supplierId      Int
  foreignCurrency String   @db.VarChar(3)
  foreignAmount   Decimal  @db.Decimal(12, 2)
  supplierRate    Decimal  @db.Decimal(10, 4)
  customerRate    Decimal  @db.Decimal(10, 4)
  netProfit       Decimal  @db.Decimal(12, 2)
  createdAt       DateTime @default(now())
  note            String?

  profitAccount Account  @relation(fields: [profitAccountId], references: [id])
  supplier      Supplier @relation(fields: [supplierId], references: [id])

  @@index([profitAccountId])
  @@index([supplierId])
}

model ExchangeTransaction {
  id            Int      @id @default(autoincrement())
  fromAccountId Int
  amountOut     Decimal  @db.Decimal(12, 2)
  toAccountId   Int
  amountIn      Decimal  @db.Decimal(12, 2)
  exchangeRate  Decimal  @db.Decimal(10, 4)
  customerName  String?
  note          String?
  createdAt     DateTime @default(now())

  fromAccount Account @relation("FromAccount", fields: [fromAccountId], references: [id])
  toAccount   Account @relation("ToAccount", fields: [toAccountId], references: [id])

  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([createdAt])
}

model Expense {
  id        Int @id @default(autoincrement())
  accountId Int

  category    String
  amount      Decimal @db.Decimal(10, 2)
  description String?

  createdAt DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id])
}

model Debt {
  id        Int @id @default(autoincrement())
  accountId Int

  borrowerName String
  amountLent   Decimal @db.Decimal(10, 2)
  amountRepaid Decimal @default(0) @db.Decimal(10, 2)

  status DebtStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id])
}

model CapitalEntry {
  id        Int @id @default(autoincrement())
  accountId Int

  source String  @default("Father")
  amount Decimal @db.Decimal(12, 2)
  note   String?

  createdAt DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id])
}

model DailyClosing {
  id        Int @id @default(autoincrement())
  accountId Int

  closingDate DateTime @default(now())

  systemBalance     Decimal  @db.Decimal(12, 2)
  actualCashBalance Decimal  @db.Decimal(12, 2)
  difference        Decimal  @db.Decimal(10, 2)
  profitPerDayMMK   Decimal? @db.Decimal(12, 2)

  note String?

  account Account @relation(fields: [accountId], references: [id])

  @@index([closingDate])
}

model CrossTransaction {
  id Int @id @default(autoincrement())

  supplierId      Int
  foreignCurrency String  @db.VarChar(3)
  foreignAmount   Decimal @db.Decimal(12, 2)

  bridgeAccountId Int
  bridgeAmount    Decimal @db.Decimal(12, 2)
  supplierRate    Decimal @db.Decimal(10, 4)

  targetAccountId Int
  targetAmount    Decimal @db.Decimal(12, 2)
  customerRate    Decimal @db.Decimal(10, 4)

  type CrossType

  note      String?
  createdAt DateTime @default(now())

  supplier      Supplier @relation(fields: [supplierId], references: [id])
  bridgeAccount Account  @relation("BridgeAccount", fields: [bridgeAccountId], references: [id])
  targetAccount Account  @relation("TargetAccount", fields: [targetAccountId], references: [id])
}

// Enums
enum Role {
  USER
  PREMIUM
  ADMIN
}

enum Status {
  ACTIVE
  INACTIVE
  FREEZE
}

enum AccountStatus {
  ACTIVE
  INACTIVE
  FREEZE
  DELETED
}

enum DebtStatus {
  PENDING
  PARTIAL
  PAID
  BAD_DEBT
}

enum CrossType {
  FOREIGN_TO_HELD
  HELD_TO_FOREIGN
}

enum Currency {
  MMK
  THB
  USD
  SGD
  EUR
  JPY
  CNY
  AED
  MYR
}

model ExchangeRate {
  id          Int      @id @default(autoincrement())
  currency    Currency @unique
  rate        Decimal  @db.Decimal(10, 4) // {currency} → MMK (e.g. 1 THB = X MMK)
  rateFromMMK Decimal  @default(0) @db.Decimal(10, 4) // MMK → {currency} (e.g. 1 MMK = X THB)
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@index([currency])
}
